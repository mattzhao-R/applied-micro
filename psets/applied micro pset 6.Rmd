---
title: "Applied Micro PSET 6"
author: "Matthew Zhao"
date: "2023-02-20"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(haven)
library(stargazer)
library(xtable)
library(lmtest)
library(sandwich)
library(broom)
library(whitestrap)
library(recipes)
library(ivreg)
library(car)
options(scipen=999)
```

## Question 2

```{r warning=F}
df <- read_dta('data/INJURY.DTA')
```

### a)

```{=tex}
\begin{equation}
\tag{1}
log(durat) = \beta + \delta afchnge + U
\end{equation}
```

```{r warning=F}
lm.parta = lm(ldurat ~ afchnge, data = df %>% filter(highearn == 1))

stargazer(lm.parta,
          type='text',digits=4, column.sep.width = "-15pt",
          dep.var.labels.include = F,
          title='Before-After estimator for treatment group')
```

Since the estimate of $\delta$ for equation 1 is positive and statistically significant at the 1% level, we conclude that the increase in workers' compensation resulted in increased time out of work based on this BA estimator for the treatment group. The main identifying assumption that must hold for this to be a causal interpretation is that there are no time-effects i.e. that $E[Y_{0t,pre}] = E[Y_{0t,post}]$. This assumption is likely not credible in this setting since there should be an effect of age on time out of work, and as a result $E[Y_{0t,pre}] \ne E[Y_{0t,post}]$.

### b)

```{r warning=F}
lm.partb = lm(ldurat ~ afchnge, data = df %>% filter(highearn == 0))

stargazer(lm.partb,
          type='text',digits=4, column.sep.width = "-15pt",
          dep.var.labels.include = F,
          title='Before-After estimator for control group')
```

This does raise doubts because we see that the estimate for the effect of being in the post period on log duration is positive for the control group. As such, we do not believe that the identifying assumption from before holds because we see that there is a difference between the outcome in pre vs post period that is not due to the treatment i.e. that $E[Y_{0t,pre}] \ne E[Y_{0t,post}]$. 

We can calculate the DiD estimator from the two BA estimators above by subtracting the BA estimate from part a by the estimate from part b. This will yield the DiD estimator because the BA estimator from part a captures the effect of the treatment as well as any time effects on the outcome, while the BA estimator from b captures only the time effects on the outcome. As a result, by subtracting the two we can difference out the time effects (assuming they are the same for both groups) to get the DiD estimator of the treatment effect. 

```{r, fig.dim=c(4,6), out.width='75%'}
df.partb <- df %>%
  group_by(afchnge, highearn) %>%
  summarise(mean_durat = mean(ldurat), .groups='keep')
ggplot() + 
  geom_point(data = df.partb %>% filter(highearn == 1), 
             mapping = aes(x = afchnge, y = mean_durat, color = 'red')) + 
  geom_point(data = df.partb %>% filter(highearn == 0), 
           mapping = aes(x = afchnge, y = mean_durat, color = 'blue')) + 
  geom_line(data = df.partb %>% filter(highearn == 1), 
             mapping = aes(x = afchnge, y = mean_durat, color = 'red')) + 
  geom_line(data = df.partb %>% filter(highearn == 0), 
           mapping = aes(x = afchnge, y = mean_durat, color = 'blue')) + 
  geom_vline(xintercept = 0.5, linetype = "dashed", alpha = 0.5) + 
  theme_light() + ggtitle("Trends in Outcomes") +
  xlab("Period") + ylab("Average Log Duration") +
  coord_fixed(xlim=c(-0.1,1.1), ylim=c(1.1,1.75)) +
  theme(plot.title = element_text(hjust = 0.5))
```

### c)

```{=tex}
\begin{equation}
\tag{2}
log(durat) = \beta_0 + \beta_1 highearn + U_i
\end{equation}
```

```{r warning=F}
lm.partc = lm(ldurat ~ highearn, data = df %>% filter(afchnge == 1))

stargazer(lm.partc,
          type='text',digits=4, column.sep.width = "-15pt",
          dep.var.labels.include = F,
          title='Cross-Section estimator for treatment group')
```

Since the coefficient on highearn is positive and statistically significant at the 1% level, we can conclude that increased workers' compensation increased log time out of work based on this CS estimator. The main identifying assumption is that there is no selection bias i.e. that $E[Y_{0i} | D_i = 1] = E[Y_{0i} | D_i = 0]$ (treatment and control groups are the same). This assumption is not credible in this setting since treatment status is based on level of earnings which likely influences time out of work. We see evidence of this in the graph from part b where the two groups are clearly different in the pre-period.

### d)

```{r warning=F}
lm.partd = lm(ldurat ~ highearn, data = df %>% filter(afchnge == 0))

stargazer(lm.partd,
          type='text',digits=4, column.sep.width = "-15pt",
          dep.var.labels.include = F,
          title='Cross-Section estimator for control group')
```

We see that the coefficient for high earning status is positive and statistically significant at the 1% level. This raises doubts about the identifying stated in part c because the significant coefficient means that there are differences in outcome between the pre-period treatment and control groups i.e. that there is selection bias and $E[Y_{0i} | D_i = 1] \ne E[Y_{0i} | D_i = 0]$. 

We can calculate the DiD estimator from the two CS estimators above by subtracting the CS estimate from part a by the estimate from part b. This will yield the DiD estimator because the CS estimator from part a captures the effect of being in the treatment group after treatment has been administered as well as the inherent effect of being in the treatment group on the outcome, while the CS estimator from b captures only the effect of being in the treatment group on the outcome. As a result, by subtracting the two we can difference out the difference between the treatment and control group (assuming they are time invariant) to get the DiD estimator of the treatment effect. 

### e)



### f)



### g)



### h)



### i)



## Question 3

### a)



### b)



### c)



## Question 4

### a)



### b)



### c)



### d)



### e)




